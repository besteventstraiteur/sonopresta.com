<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>SonoPresta</title>

  <!-- Valeurs par défaut pour éviter tout flash et garantir un thème même si l'API tombe -->
  <style>
    :root {
      --primary: #111111;
      --secondary: #ffffff;
      --accent: #06b6d4;
      --radius: 12px;
    }
    html, body { margin: 0; padding: 0; }
  </style>

  <!-- (Optionnel) Feuille de style générée par Vite : mets ici le bon hash si tu en as un -->
  <!-- <link rel="stylesheet" href="/assets/index-REPLACE_WITH_CSS_HASH.css" crossorigin> -->
</head>
<body>
  <div id="root"></div>
  <noscript>Veuillez activer JavaScript pour afficher ce site.</noscript>

  <!-- BOOTSTRAP SÛR : 1 seul bloc. Pas de monkey-patch de fetch. Pas de doublon d’handlers. -->
  <script id="bootstrap">
    (function () {
      function showFatalFallback() {
        if (document.getElementById('fatal')) return;
        const el = document.createElement('div');
        el.id = 'fatal';
        el.style.cssText =
          'position:fixed;inset:0;padding:24px;display:flex;align-items:center;justify-content:center;' +
          'font-family:system-ui,Segoe UI,Roboto,Arial;background:#0b0b0b;color:#fff;z-index:999999;';
        el.innerHTML =
          '<div style="max-width:620px;text-align:center;line-height:1.4;">' +
          '<h1 style="font-size:22px;margin:0 0 8px;">Un souci technique empêche l’affichage complet</h1>' +
          '<p style="opacity:.8;margin:0 0 16px;">Réessaye dans un instant. Le contenu s’affiche dès que l’API répond.</p>' +
          '<button style="padding:10px 16px;border-radius:10px;border:0;cursor:pointer;">Recharger</button>' +
          '</div>';
        el.querySelector('button').onclick = () => location.reload();
        document.body.appendChild(el);
      }
      window.addEventListener('error', showFatalFallback);
      window.addEventListener('unhandledrejection', showFatalFallback);

      async function getJSON(url) {
        try {
          const res = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          try { return await res.json(); } catch { return {}; }
        } catch (e) {
          console.warn('[API]', url, e && e.message ? e.message : e);
          return {}; // jamais d’exception vers l’UI
        }
      }
      function normalizeCustomizer(raw) {
        const d = { primary:'#111111', secondary:'#ffffff', accent:'#06b6d4', borderRadius:'12px', logo:null };
        const r = (raw && typeof raw === 'object') ? raw : {};
        const val = (v,f)=> (typeof v === 'string' && v.trim()) ? v.trim() : f;
        const radius = (v)=> {
          if (v == null) return d.borderRadius;
          const s = String(v).trim();
          return /^\d+$/.test(s) ? (s + 'px') : (s || d.borderRadius);
        };
        return {
          primary: val(r.primary, d.primary),
          secondary: val(r.secondary, d.secondary),
          accent: val(r.accent, d.accent),
          borderRadius: radius(r.borderRadius ?? r.radius),
          logo: r.logo ?? d.logo,
        };
      }

      (async function boot() {
        // Tente de charger le customizer ; n'échoue jamais côté UI
        const raw = await getJSON('/backend/public/api/option/customizer');
        const theme = normalizeCustomizer(raw?.data ?? raw);

        // Applique les variables CSS globales
        const root = document.documentElement;
        root.style.setProperty('--primary', theme.primary);
        root.style.setProperty('--secondary', theme.secondary);
        root.style.setProperty('--accent', theme.accent);
        root.style.setProperty('--radius', theme.borderRadius);

        // Expose si besoin par le bundle
        window.__THEME__ = theme;
      })();
    })();
  </script>

  <!-- ⚠️ IMPORTANT : ne garde QU’UNE SEULE inclusion du bundle -->
  <!-- Si le nom de fichier diffère, mets celui présent dans /assets -->
  <script type="module" src="/assets/index-BkUmda.js" crossorigin></script>

  <!-- (Optionnel) Tes autres scripts "non dupliqués" (ex: Google Translate) peuvent rester ici,
       mais supprime toute seconde copie et tout patch custom de fetch. -->
</body>
</html>
