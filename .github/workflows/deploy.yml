name: Deploy Sonopresta to OVH (SFTP via lftp)

on:
  push:
    branches: [ main ]          # Déploie à chaque push sur main
  workflow_dispatch:            # Permet aussi de lancer manuellement

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      # Déploiement SFTP par mirroring avec mot de passe
      - name: Mirror ./www -> /home/sonoprf/www (OVH SFTP)
        env:
          OVH_HOST: ${{ secrets.OVH_HOST }}
          OVH_USER: ${{ secrets.OVH_USER }}
          OVH_PASSWORD: ${{ secrets.OVH_PASSWORD }}
        run: |
          set -e
          # ne pas afficher le mot de passe dans les logs
          set +x
          lftp -u "$OVH_USER","$OVH_PASSWORD" sftp://$OVH_HOST <<'EOF'
          set sftp:auto-confirm yes
          set net:max-retries 2
          set net:timeout 20
          mirror -R \
            --parallel=4 \
            --only-newer \
            --exclude-glob '.git*' \
            --exclude-glob '.github*' \
            --exclude-glob 'node_modules*' \
            --exclude-glob '*.md' \
            --exclude-glob '*.map' \
            --exclude-glob '.env*' \
            ./www /home/sonoprf/www
          bye
          EOF

      # (Optionnel) Healthcheck
      # - name: Healthcheck homepage
      #   run: |
      #     STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://www.sonopresta.com/)
      #     [ "$STATUS" = "200" ] || (echo "Healthcheck failed: $STATUS" && exit 1)
# Fin du workflow
